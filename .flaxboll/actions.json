{"1771434776141":{"actionType":"saveAll","createdAt":"1771434776141","actionID":"1771434776141","userID":"#TEMP","path":"system.capsules.a65ab14f-de80-4fd6-aadf-de7aa1fccf27.capsUseCodeInfo.capsUseInputs.sss_custom_caps-0.capsIptTxtValue","oldValue":"() => {\n  const cart = tools.getCtData(\"sc.C4.forms.iptsChanges.products\");\n\n  console.log(\"üõí Carrinho recebido:\", cart);\n\n  if (!Array.isArray(cart)) {\n    console.log(\"ERRO: cart n√£o √© array\");\n    return \"ERROR\";\n  }\n\n  if (cart.length === 0) {\n    console.log(\"Carrinho vazio\");\n    return \"R$ 0,00\";\n  }\n\n  const parsePrice = (p) => {\n    console.log(\"Lendo price bruto:\", p);\n\n    if (!p || typeof p !== \"string\") {\n      console.log(\"price inv√°lido:\", p);\n      return 0;\n    }\n\n    // Remove pontos e converte v√≠rgula para ponto\n    const cleaned = p\n      .replace(\"R$\", \"\")        // remove prefixo\n      .replace(/\\s+/g, \"\")      // remove espa√ßos\n      .replace(/\\./g, \"\")       // remove todos os pontos (milhares)\n      .replace(\",\", \".\")        // troca v√≠rgula por ponto\n      .trim();\n\n    const num = Number(cleaned);\n\n    console.log(\"price limpo: \" + cleaned + \" | N√∫mero: \" + num);\n\n    return isNaN(num) ? 0 : num;\n  };\n\n  let total = 0;\n\n  cart.forEach((item, index) => {\n    console.log(\"Item \" + index + \": \", item);\n\n    const price = parsePrice(item.price);\n\n    console.log(\"Pre√ßo convertido do item \" + index + \": \" + price);\n\n    total += price;\n  });\n\n  const formatted = total.toLocaleString(\"pt-BR\", {\n    style: \"currency\",\n    currency: \"BRL\",\n  });\n\n  console.log(\"TOTAL CALCULADO: \" + total + \" | Formatado: \" + formatted);\n\n  tools.functions.setVar({\n    args: \"\",\n    pass: {\n      keyPath: [\"sc.C4.forms.iptsChanges.totalPrice\"],\n      value: [formatted],\n    },\n  });\n\n  return formatted;\n}\n","newValue":"() => {\n  const cart = tools.getCtData(\"sc.C4.forms.iptsChanges.products\");\n\n  console.log(\"üõí Carrinho recebido:\", cart);\n\n  if (!Array.isArray(cart)) {\n    console.log(\"ERRO: cart n√£o √© array\");\n    return \"ERROR\";\n  }\n\n  if (cart.length === 0) {\n    console.log(\"Carrinho vazio\");\n    return \"R$ 0,00\";\n  }\n\n  const parsePrice = (p) => {\n    console.log(\"Lendo price bruto:\", p);\n\n    if (!p || typeof p !== \"string\") {\n      console.log(\"price inv√°lido:\", p);\n      return 0;\n    }\n\n    // Remove pontos e converte v√≠rgula para ponto\n    const cleaned = p\n      .replace(\"R$\", \"\")        // remove prefixo\n      .replace(/\\s+/g, \"\")      // remove espa√ßos\n      .replace(/\\./g, \"\")       // remove todos os pontos (milhares)\n      .replace(\",\", \".\")        // troca v√≠rgula por ponto\n      .trim();\n\n    const num = Number(cleaned);\n\n    console.log(\"price limpo: \" + cleaned + \" | N√∫mero: \" + num);\n\n    return isNaN(num) ? 0 : num;\n  };\n\n  let total = 0;\n\n  cart.forEach((item, index) => {\n    console.log(\"Item \" + index + \": \", item);\n\n    const price = parsePrice(item.price);\n\n    console.log(\"Pre√ßo convertido do item \" + index + \": \" + price);\n\n    total += price;\n  });\n\n  const formatted = total.toLocaleString(\"pt-BR\", {\n    style: \"currency\",\n    currency: \"BRL\",\n  });\n\n  console.log(\"TOTAL CALCULADO: \" + total + \" | Formatado: \" + formatted);\n\n  tools.functions.setVar({\n    args: \"\",\n    pass: {\n      keyPath: [\"sc.C4.forms.iptsChanges.totalPrice\"],\n      value: [formatted],\n    },\n  });\n\n  return formatted;\n}"}}