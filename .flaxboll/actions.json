{"1771438028621":{"actionType":"saveAll","createdAt":"1771438028621","actionID":"1771438028621","userID":"#TEMP","path":"system.capsules.a65ab14f-de80-4fd6-aadf-de7aa1fccf27.capsUseCodeInfo.capsUseInputs.sss_custom_caps-0.capsIptTxtValue","oldValue":"() => {\n  const cart = tools.getCtData(\"sc.C4.forms.iptsChanges.products\");\n\n  console.log(\"üõí Carrinho recebido:\", cart);\n\n  if (!Array.isArray(cart)) {\n    console.log(\"ERRO: cart n√£o √© array\");\n    return \"ERROR\";\n  }\n\n  if (cart.length === 0) {\n    console.log(\"Carrinho vazio\");\n    return \"R$ 0,00\";\n  }\n\n//========\n\nconst parsePrice = (p) => {\n  console.log(\"=== Iniciando parsePrice ===\");\n  console.log(\"Valor bruto recebido:\", p);\n\n  if (!p || typeof p !== \"string\") {\n    console.log(\"‚ùå price inv√°lido:\", p);\n    return 0;\n  }\n\n  // Remove R$ e espa√ßos extras\n  let cleaned = p.replace(/R\\$\\s*/g, \"\").trim();\n  console.log(\"Ap√≥s remover R$ e espa√ßos:\", cleaned);\n\n  // Mant√©m apenas d√≠gitos, v√≠rgula e ponto\n  cleaned = cleaned.replace(/[^\\d.,]/g, \"\");\n  console.log(\"Ap√≥s remover caracteres n√£o num√©ricos:\", cleaned);\n\n  if (cleaned.includes(\",\")) {\n    console.log(\"Detectado formato brasileiro (v√≠rgula como decimal)\");\n    cleaned = cleaned.replace(/\\./g, \"\"); // remove pontos de milhar\n    cleaned = cleaned.replace(\",\", \".\");  // v√≠rgula vira ponto decimal\n  } else {\n    console.log(\"Detectado formato americano (ponto como decimal)\");\n    cleaned = cleaned.replace(/,/g, \"\");  // remove v√≠rgulas de milhar\n  }\n\n  console.log(\"String final antes da convers√£o:\", cleaned);\n\n  const num = Number(cleaned);\n\n  if (isNaN(num)) {\n    console.log(\"‚ùå Falha na convers√£o. Resultado NaN.\");\n    return 0;\n  }\n\n  console.log(\"‚úÖ Convers√£o bem-sucedida. N√∫mero:\", num);\n  console.log(\"=== Fim parsePrice ===\")\n;\n\n\n  return num;\n};\n\n\n//========\n\n  let total = 0;\n\n  cart.forEach((item, index) => {\n    console.log(\"Item \" + index + \": \", item);\n\n    const price = parsePrice(item.price);\n\n    console.log(\"Pre√ßo convertido do item \" + index + \": \" + price);\n\n    total += price;\n  });\n\n  const formatted = total.toLocaleString(\"pt-BR\", {\n    style: \"currency\",\n    currency: \"BRL\",\n  });\n\n  console.log(\"TOTAL CALCULADO: \" + total + \" | Formatado: \" + formatted);\n\n  tools.functions.setVar({\n    args: \"\",\n    pass: {\n      keyPath: [\"sc.C4.forms.iptsChanges.totalPrice\"],\n      value: [formatted],\n    },\n  });\n\n  return formatted;\n}","newValue":"() => {\n  const cart = tools.getCtData(\"sc.C4.forms.iptsChanges.products\");\n\n  console.log(\"üõí Carrinho recebido:\", cart);\n\n  if (!Array.isArray(cart)) {\n    console.log(\"ERRO: cart n√£o √© array\");\n    return \"ERROR\";\n  }\n\n  if (cart.length === 0) {\n    console.log(\"Carrinho vazio\");\n    return \"R$ 0,00\";\n  }\n\n//========\n\nconst parsePrice = (p) => {\n  console.log(\"=== Iniciando parsePrice ===\");\n  console.log(\"Valor bruto recebido:\", p);\n\n  if (!p || typeof p !== \"string\") {\n    console.log(\"‚ùå price inv√°lido:\", p);\n    return 0;\n  }\n\n  // Remove R$ e espa√ßos extras\n  let cleaned = p.replace(/R\\$\\s*/g, \"\").trim();\n  console.log(\"Ap√≥s remover R$ e espa√ßos:\", cleaned);\n\n  // Mant√©m apenas d√≠gitos, v√≠rgula e ponto\n  cleaned = cleaned.replace(/[^\\d.,]/g, \"\");\n  console.log(\"Ap√≥s remover caracteres n√£o num√©ricos:\", cleaned);\n\n  if (cleaned.includes(\",\")) {\n    console.log(\"Detectado formato brasileiro (v√≠rgula como decimal)\");\n    cleaned = cleaned.replace(/\\./g, \"\"); // remove pontos de milhar\n    cleaned = cleaned.replace(\",\", \".\");  // v√≠rgula vira ponto decimal\n  } else {\n    console.log(\"Detectado formato americano (ponto como decimal)\");\n    cleaned = cleaned.replace(/,/g, \"\");  // remove v√≠rgulas de milhar\n  }\n\n  console.log(\"String final antes da convers√£o:\", cleaned);\n\n  const num = Number(cleaned);\n\n  if (isNaN(num)) {\n    console.log(\"‚ùå Falha na convers√£o. Resultado NaN.\");\n    return 0;\n  }\n\n  console.log(\"‚úÖ Convers√£o bem-sucedida. N√∫mero:\", num);\n  console.log(\"=== Fim parsePrice ===\")\nconsole.log(parsePrice(\"R$ 5.00\"));      // 5\nconsole.log(parsePrice(\"R$ 1.234,56\"));  // 1234.56\nconsole.log(parsePrice(\"R$ 12.345,67\")); // 12345.67\nconsole.log(parsePrice(\"R$ 1,234.56\"));  // 1234.56;\n\n\n  return num;\n};\n\n\n//========\n\n  let total = 0;\n\n  cart.forEach((item, index) => {\n    console.log(\"Item \" + index + \": \", item);\n\n    const price = parsePrice(item.price);\n\n    console.log(\"Pre√ßo convertido do item \" + index + \": \" + price);\n\n    total += price;\n  });\n\n  const formatted = total.toLocaleString(\"pt-BR\", {\n    style: \"currency\",\n    currency: \"BRL\",\n  });\n\n  console.log(\"TOTAL CALCULADO: \" + total + \" | Formatado: \" + formatted);\n\n  tools.functions.setVar({\n    args: \"\",\n    pass: {\n      keyPath: [\"sc.C4.forms.iptsChanges.totalPrice\"],\n      value: [formatted],\n    },\n  });\n\n  return formatted;\n}"}}